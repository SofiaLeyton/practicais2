version: "3.8"

services:

  # ==========================
  #  BASE DE DATOS MONGO ÃšNICA
  # ==========================
  mongodb:
    image: mongo:4.4
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - micro_net
    restart: always


  # =====================
  #  MICROSERVICIO PRODUCTOS
  # =====================
  microservicio_productos:
    build: ./contenedor_productos
    container_name: microservicio_productos
    ports:
      - "5000:5000"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/microservicios
    depends_on:
      - mongodb
    networks:
      - micro_net
    restart: always


  # =====================
  #  MICROSERVICIO PEDIDOS
  # =====================
  pedidos_api:
    build: ./contenedor_pedidos
    container_name: pedidos_api
    ports:
      - "5001:5001"
    environment:
      - MONGO_URL=mongodb://mongodb:27017/microservicios
    depends_on:
      - mongodb
    networks:
      - micro_net
    restart: always


  # =====================
  #  MICROSERVICIO REPORTES
  # =====================
  microservicio_reportes:
    build: ./contenedor_reportes
    container_name: microservicio_reportes
    command: python manage.py runserver 0.0.0.0:8002
    ports:
      - "8002:8002"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/microservicios
    depends_on:
      - mongodb
    networks:
      - micro_net
    restart: always


  # ==========================
  #  MICROSERVICIO CORREOS (LARAVEL)
  # ==========================
  correos_app:
    build: ./contenedor_correos
    container_name: microservicio_correos
    working_dir: /var/www
    volumes:
      - ./contenedor_correos/proyectoLaravel:/var/www
    ports:
      - "8000:8000"
    depends_on:
      - correos_db
    command: bash -c "composer install && php artisan key:generate && php artisan serve --host=0.0.0.0 --port=8000"
    networks:
      - micro_net
    restart: always

  correos_db:
    image: mysql:8
    container_name: correos_db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: laravel
      MYSQL_USER: laravel
      MYSQL_PASSWORD: laravel
    ports:
      - "3307:3306"
    volumes:
      - correos_data:/var/lib/mysql
    networks:
      - micro_net
    restart: always


  # ==========================
  #  MICROSERVICIO SEGURIDAD (PHP/APACHE)
  # ==========================
  seguridad_app:
    build:
      context: ./contenedor_seguridad/microservicio_seguridad
    container_name: seguridad_app
    restart: always
    volumes:
      - ./contenedor_seguridad/microservicio_seguridad:/var/www
    depends_on:
      - seguridad_db
    networks:
      - seguridad_network

  seguridad_nginx:
    image: nginx:latest
    container_name: seguridad_nginx
    restart: always
    ports:
      - "8003:80"  # Este es el puerto para tu API
    volumes:
      - ./contenedor_seguridad/microservicio_seguridad:/var/www
      - ./contenedor_seguridad/microservicio_seguridad/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - seguridad_app
    networks:
      - seguridad_network

  seguridad_db:
    image: mysql:8.0
    container_name: seguridad_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: seguridad
      MYSQL_USER: seguridad
      MYSQL_PASSWORD: seguridad
    ports:
      - "3308:3306"
    volumes:
      - seguridad_db_data:/var/lib/mysql
    networks:
      - seguridad_network



  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: gateway
    restart: always
    volumes:
      - ./gateway:/var/www
    networks:
      - micro_net

  nginx_gateway:
    image: nginx:latest
    container_name: nginx_gateway
    restart: always
    ports:
      - "9000:80"
    volumes:
      - ./gateway:/var/www
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - gateway
    networks:
      - micro_net
# ==========================
# RED COMPARTIDA PARA TODO
# ==========================
networks:
  micro_net:
    driver: bridge

  seguridad_network:
    driver: bridge
# ==========================
# VOLUMENES COMPARTIDOS
# ==========================
volumes:
  mongo_data:
  correos_data:
  seguridad_data:
  seguridad_db_data: