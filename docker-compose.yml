version: "3.8"

services:

  # ==========================
  # BASE DE DATOS MONGO
  # ==========================
  mongodb:
    image: mongo:4.4
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - micro_net
    restart: always

  # ==========================
  # MICROSERVICIO PRODUCTOS
  # ==========================
  microservicio_productos:
    build: ./contenedor_productos
    container_name: microservicio_productos
    ports:
      - "5000:5000"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/microservicios
    depends_on:
      - mongodb
    networks:
      - micro_net
    restart: always

  # ==========================
  # MICROSERVICIO PEDIDOS
  # ==========================
  pedidos_api:
    build: ./contenedor_pedidos
    container_name: pedidos_api
    ports:
      - "5001:5001"
    environment:
      - MONGO_URL=mongodb://mongodb:27017/microservicios
    depends_on:
      - mongodb
    networks:
      - micro_net
    restart: always

  # ==========================
  # MICROSERVICIO REPORTES
  # ==========================
  microservicio_reportes:
    build: ./contenedor_reportes
    container_name: microservicio_reportes
    command: python manage.py runserver 0.0.0.0:8002
    ports:
      - "8002:8002"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/microservicios
    depends_on:
      - mongodb
    networks:
      - micro_net
    restart: always

  # ==========================
  # MICROSERVICIO CORREOS (LARAVEL)
  # ==========================
  correos_app:
    build: ./contenedor_correos
    container_name: microservicio_correos
    working_dir: /var/www
    volumes:
      - ./contenedor_correos/proyectoLaravel:/var/www
    ports:
      - "8000:8000"
    depends_on:
      - correos_db
    command: bash -c "composer install && php artisan key:generate && php artisan serve --host=0.0.0.0 --port=8000"
    networks:
      - micro_net
    restart: always

  correos_db:
    image: mysql:8
    container_name: correos_db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: laravel
      MYSQL_USER: laravel
      MYSQL_PASSWORD: laravel
    ports:
      - "3307:3306"
    volumes:
      - correos_data:/var/lib/mysql
    networks:
      - micro_net
    restart: always

  # ==========================
  # MICROSERVICIO SEGURIDAD (PHP/APACHE)
  # ==========================
  seguridad_app:
    build:
      context: ./contenedor_seguridad/microservicio_seguridad
    container_name: seguridad_app
    restart: always
    volumes:
      - ./contenedor_seguridad/microservicio_seguridad:/var/www
    ports:
      - "8003:80"  # Exponer Apache directamente
    depends_on:
      - seguridad_db
    networks:
      - micro_net

  seguridad_db:
    image: mysql:8.0
    container_name: seguridad_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: seguridad
      MYSQL_USER: seguridad
      MYSQL_PASSWORD: seguridad
    ports:
      - "3308:3306"
    volumes:
      - seguridad_db_data:/var/lib/mysql
    networks:
      - micro_net

  # ==========================
  # GATEWAY 
  # ==========================
  gateway:
    build:
      context: ./gateway
    container_name: gateway
    restart: always
    volumes:
      - ./gateway:/var/www
    ports:
      - "9000:80"
    networks:
      - micro_net

# ==========================
# RED
# ==========================
networks:
  micro_net:
    driver: bridge

# ==========================
# VOLUMES
# ==========================
volumes:
  mongo_data:
  correos_data:
  seguridad_db_data:
